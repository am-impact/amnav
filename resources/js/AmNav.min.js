!function(e){Craft.AmNav=Garnish.Base.extend({id:null,entryModal:null,categoryModal:null,assetModal:null,currentElementType:null,structure:null,locale:null,siteUrl:"",savingNode:!1,entrySources:"",$template:e("#amnav__row").html(),$buildContainer:e(".amnav__builder"),$parentContainer:e(".amnav__parent"),$newWindowElement:e('.amnav .field input[name="blank"]'),$addElementButton:e(".amnav__button"),$addElementLoader:e(".amnav .buttons .spinner"),$manualForm:e("#manual-form"),$manualLoader:e("#manual-form").find(".spinner"),$displayIdsButton:e(".amnav__nodeids"),init:function(e,t){this.id=e,this.locale=t.locale,this.siteUrl=t.siteUrl,this.entrySources=t.entrySources,this.structure=new Craft.AmNavStructure(e,"#amnav__builder",".amnav__builder",t),this.addListener(this.$addElementButton,"activate","showModal"),this.addListener(this.$manualForm,"submit","onManualSubmit"),this.addListener(this.$displayIdsButton,"click","showNodeIds")},showModal:function(t){this.savingNode||(this.currentElementType=e(t.currentTarget).data("element-type"),"Entry"==this.currentElementType?this.entryModal?this.entryModal.show():this.entryModal=this.createModal("Entry",this.entrySources):"Category"==this.currentElementType?this.categoryModal?this.categoryModal.show():this.categoryModal=this.createModal("Category","*"):"Asset"==this.currentElementType&&(this.assetModal?this.assetModal.show():this.assetModal=this.createModal("Asset","*")))},createModal:function(t,a){return Craft.createElementSelectorModal(t,{criteria:{locale:this.locale},sources:a,multiSelect:!0,onSelect:e.proxy(this,"onModalSelect")})},onModalSelect:function(e){for(var t=this.$parentContainer.find("#parent").val(),a=this.currentElementType,n=0;n<e.length;n++){var i=e[n];"Entry"==a?this.entryModal.$body.find('.element[data-id="'+i.id+'"]').closest("tr").removeClass("sel"):"Category"==a?this.categoryModal.$body.find('.element[data-id="'+i.id+'"]').closest("tr").removeClass("sel"):"Asset"==a&&this.assetModal.$body.find('.element[data-id="'+i.id+'"]').closest("tr").removeClass("sel");var s={navId:this.id,name:i.label,enabled:"live"==i.status,elementId:i.id,elementType:a,blank:"1"==this.$newWindowElement.val(),locale:this.locale,parentId:void 0===t?0:t};this.saveNewNode(s,a)}},onManualSubmit:function(e){if(!this.savingNode){var t=this.$parentContainer.find("#parent").val(),a={navId:this.id,name:this.$manualForm.find("#name").val(),url:this.$manualForm.find("#url").val(),blank:"1"==this.$newWindowElement.val(),locale:this.locale,parentId:void 0===t?0:t};this.saveNewNode(a,"manual")}e.preventDefault()},saveNewNode:function(t,a){this.savingNode=!0,"manual"==a?this.$manualLoader.removeClass("hidden"):this.$addElementLoader.removeClass("hidden"),Craft.postActionRequest("amNav/nodes/saveNewNode",t,e.proxy(function(e,t){"success"==t&&(this.savingNode=!1,"manual"==a?this.$manualLoader.addClass("hidden"):this.$addElementLoader.addClass("hidden"),e.success?("manual"==a&&(this.$manualForm.find("#name").val(""),this.$manualForm.find("#url").val("")),this.addNode(e.nodeData),this.$parentContainer.html(e.parentOptions),Craft.cp.displayNotice(e.message)):Craft.cp.displayError(e.message))},this))},addNode:function(t){var a=this.$template.replace(/%%id%%/gi,t.id).replace(/%%status%%/gi,t.enabled?"live":"expired").replace(/%%label%%/gi,t.name).replace(/%%type%%/gi,t.elementType?t.elementType.toLowerCase():"manual").replace(/%%typeLabel%%/gi,t.elementType?Craft.t(t.elementType):Craft.t("Manual")).replace(/%%url%%/gi,t.url.replace("{siteUrl}",this.siteUrl)).replace(/%%urlless%%/gi,t.url.replace("{siteUrl}","")).replace(/%%blank%%/gi,t.blank?"":"visuallyhidden"),n=e(a);this.structure.addElement(n,t.parentId)},showNodeIds:function(){e(".amnav__id").toggleClass("visuallyhidden")}}),Craft.AmNavStructure=Craft.Structure.extend({navId:null,$emptyContainer:e(".amnav__empty"),init:function(t,a,n,i){if(this.navId=t,this.base(a,n,i),this.structureDrag=new Craft.AmNavStructureDrag(this,this.settings.maxLevels),this.$container.find(".settings").on("click",e.proxy(function(t){this.showNodeEditor(e(t.currentTarget).parent().children(".amnav__node"))},this)),this.$container.find(".delete").on("click",e.proxy(function(t){this.removeElement(e(t.currentTarget))},this)),this.addListener(e(".amnav__node"),"dblclick",function(t){this.showNodeEditor(e(t.currentTarget))}),!this.settings.isAdmin&&this.settings.canMoveFromLevel>1){var s=this,r=this.$container.find("li").filter(function(){return e(this).data("level")<s.settings.canMoveFromLevel});this.structureDrag.removeItems(r)}},addElement:function(t,a){var n=this.$container,i=1;if(a>0){var s=this.$container.find('.amnav__node[data-id="'+a+'"]').closest("li"),r=s.find("> ul"),d=s.data("level");r.length||(r=e("<ul/>"),r.appendTo(s)),n=r,i=d+1}var l=e('<li data-level="'+i+'"/>').appendTo(n),o=this.getIndent(i),h=e('<div class="row" style="margin-'+Craft.left+": -"+o+"px; padding-"+Craft.left+": "+o+'px;">').appendTo(l);h.append(t),h.append('<a class="move icon" title="'+Craft.t("Move")+'"></a>'),h.append('<a class="settings icon" title="'+Craft.t("Settings")+'"></a>'),h.append('<a class="delete icon" title="'+Craft.t("Delete")+'"></a>'),this.structureDrag.addItems(l),h.find(".settings").on("click",e.proxy(function(t){this.showNodeEditor(e(t.currentTarget).parent().children(".amnav__node"))},this)),h.find(".delete").on("click",e.proxy(function(t){this.removeElement(e(t.currentTarget))},this)),h.find(".amnav__node").on("dblclick",e.proxy(function(t){this.showNodeEditor(e(t.currentTarget))},this)),h.css("margin-bottom",-30),h.velocity({"margin-bottom":0},"fast"),this.$container.find(".amnav__node").length&&this.$emptyContainer.addClass("hidden")},removeElement:function(t){var a=t.closest("li");if(confirmation=confirm(Craft.t("Are you sure you want to delete “{name}” and its descendants?",{name:a.find(".amnav__node").data("label")})),confirmation){if(this.removeNode(t.parent().find(".amnav__node")),this.structureDrag.removeItems(a),!a.siblings().length)var n=a.parent();a.css("visibility","hidden").velocity({marginBottom:-a.height()},"fast",e.proxy(function(){a.remove(),this.$container.find(".amnav__node").length||this.$emptyContainer.removeClass("hidden"),"undefined"!=typeof n&&"amnav__builder"!=n.attr("id")&&this._removeUl(n)},this))}},removeNode:function(t){var a=t.data("id"),n={nodeId:a};Craft.postActionRequest("amNav/nodes/deleteNode",n,e.proxy(function(t,a){"success"==a&&t.success&&(e(".amnav__parent").html(t.parentOptions),Craft.cp.displayNotice(t.message))},this))},showNodeEditor:function(e){new Craft.AmNavEditor(e)}}),Craft.AmNavStructureDrag=Craft.StructureDrag.extend({onDragStop:function(){if(this._.$closestTarget&&(this.$insertion.parent().length||this._.$closestTarget.hasClass("draghover"))){if(this.$draggee.siblings().length)var t=null;else var t=this.$draggee.parent();if(this.$insertion.parent().length){var a=this.$insertion.next().add(this.$insertion.prev());if(-1==e.inArray(this.$draggee[0],a)){this.$insertion.replaceWith(this.$draggee);var n=!0}else{this.$insertion.remove();var n=!1}}else{var i=this._.$closestTargetLi.children("ul");if(t&&i.length&&i[0]==t[0])var n=!1;else{if(i.length)this._.$closestTargetLi.hasClass("collapsed")&&this._.$closestTarget.children(".toggle").trigger("click");else{var s=e('<div class="toggle" title="'+Craft.t("Show/hide children")+'"/>').prependTo(this._.$closestTarget);this.structure.initToggle(s),i=e("<ul>").appendTo(this._.$closestTargetLi)}this.$draggee.appendTo(i);var n=!0}}if(this._.$closestTarget.removeClass("draghover"),n){t&&this.structure._removeUl(t);var r=this.$draggee.parentsUntil(this.structure.$container,"li").length+1;if(r!=this.$draggee.data("level")){if(1==this.$draggee.data("level")){var d={};d["padding-"+Craft.left]=38,this.$helperLi.velocity(d,"fast")}else if(1==r){var d={};d["padding-"+Craft.left]=Craft.Structure.baseIndent,this.$helperLi.velocity(d,"fast")}this.setLevel(this.$draggee,r)}var l=this.$draggee.children(".row").children(".element"),o={navId:this.structure.navId,nodeId:l.data("id"),prevId:l.closest("li").prev().children(".row").children(".element").data("id"),parentId:this.$draggee.parent("ul").parent("li").children(".row").children(".element").data("id")};Craft.postActionRequest("amNav/nodes/moveNode",o,function(t,a){"success"==a&&(e(".amnav__parent").html(t.parentOptions),Craft.cp.displayNotice(Craft.t("New order saved.")))})}}this.$draggee.stop().removeClass("hidden").velocity({height:this.draggeeHeight},"fast",e.proxy(function(){this.$draggee.css("height","auto")},this)),this.returnHelpersToDraggees(),this.base()}}),Craft.AmNavEditor=Garnish.Base.extend({$node:null,nodeId:null,$form:null,$fieldsContainer:null,$cancelBtn:null,$saveBtn:null,$spinner:null,hud:null,init:function(t){this.$node=t,this.nodeId=t.data("id"),this.$node.addClass("loading");var a={nodeId:this.nodeId};Craft.postActionRequest("amNav/nodes/getEditorHtml",a,e.proxy(this,"showHud"))},showHud:function(t,a){if(this.$node.removeClass("loading"),"success"==a){var n=e();this.$form=e("<form/>"),e('<input type="hidden" name="nodeId" value="'+this.nodeId+'">').appendTo(this.$form),this.$fieldsContainer=e('<div class="fields"/>').appendTo(this.$form),this.$fieldsContainer.html(t.html),Craft.initUiElements(this.$fieldsContainer);var i=e('<div class="footer"/>').appendTo(this.$form);this.$spinner=e('<div class="spinner left hidden"/>').appendTo(i);var s=e('<div class="buttons right"/>').appendTo(i);this.$cancelBtn=e('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(s),this.$saveBtn=e('<input class="btn submit" type="submit" value="'+Craft.t("Save")+'"/>').appendTo(s),n=n.add(this.$form),this.hud=new Garnish.HUD(this.$node,n,{bodyClass:"body elementeditor",closeOtherHUDs:!1}),this.hud.on("hide",e.proxy(function(){delete this.hud},this)),this.addListener(this.$saveBtn,"click","saveNode"),this.addListener(this.$cancelBtn,"click",function(){this.hud.hide()})}},saveNode:function(t){t.preventDefault(),this.$spinner.removeClass("hidden");var a=this.$form.serialize(),n=this.$node.find(".status"),i=this.$node.find(".amnav__blank"),s=this.$node.find(".amnav__listclass");Craft.postActionRequest("amNav/nodes/saveNode",a,e.proxy(function(e,t){this.$spinner.addClass("hidden"),"success"==t&&("success"==t&&e.success?(Craft.cp.displayNotice(e.message),this.$node.data("label",e.nodeData.name),this.$node.find(".title").text(e.nodeData.name),e.nodeData.enabled?(n.addClass("live"),n.removeClass("expired")):(n.addClass("expired"),n.removeClass("live")),e.nodeData.blank?i.removeClass("visuallyhidden"):i.addClass("visuallyhidden"),s.length&&s.text((e.nodeData.listClass.length?".":"")+e.nodeData.listClass),this.closeHud()):Garnish.shake(this.hud.$hud))},this))},closeHud:function(){this.hud.hide(),delete this.hud}})}(jQuery);
