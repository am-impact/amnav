!function(e){Craft.AmNav=Garnish.Base.extend({id:null,modal:null,structure:null,locale:null,siteUrl:Craft.getSiteUrl(),savingPage:!1,$template:e("#amnav__row").html(),$buildContainer:e(".amnav__builder"),$parentContainer:e(".amnav__parent"),$addEntryButton:e(".amnav__button"),$addEntryLoader:e(".amnav__button").parent().find(".spinner"),$manualForm:e("#manual-form"),$manualLoader:e("#manual-form").find(".spinner"),$displayIdsButton:e(".amnav__pageids"),init:function(e,t,a){this.id=e,this.locale=t,this.structure=new Craft.AmNavStructure(e,"#amnav__builder",".amnav__builder",a),this.addListener(this.$addEntryButton,"activate","showModal"),this.addListener(this.$manualForm,"submit","onManualSubmit"),this.addListener(this.$displayIdsButton,"click","showPageIds")},showModal:function(){this.savingPage||(this.modal?this.modal.show():this.modal=this.createModal())},createModal:function(){return Craft.createElementSelectorModal("Entry",{criteria:{locale:this.locale},multiSelect:!0,onSelect:e.proxy(this,"onModalSelect")})},onModalSelect:function(e){for(var t=this.$parentContainer.find("#parent").val(),a=0;a<e.length;a++){var i=e[a];this.modal.$body.find('.element[data-id="'+i.id+'"]').closest("tr").removeClass("sel"),i.url=i.url.replace(this.siteUrl,"{siteUrl}");var s={navId:this.id,name:i.label,url:i.url,enabled:"live"==i.status,entryId:i.id,locale:this.locale,parentId:void 0===t?0:t};this.saveNewPage(s,!1)}},onManualSubmit:function(e){if(!this.savingPage){var t=this.$parentContainer.find("#parent").val(),a={navId:this.id,name:this.$manualForm.find("#name").val(),url:this.$manualForm.find("#url").val(),blank:"1"==this.$manualForm.find('input[name="blank"]').val(),locale:this.locale,parentId:void 0===t?0:t};this.saveNewPage(a,!0)}e.preventDefault()},saveNewPage:function(t,a){this.savingPage=!0,a?this.$manualLoader.removeClass("hidden"):this.$addEntryLoader.removeClass("hidden"),Craft.postActionRequest("amNav/pages/saveNewPage",t,e.proxy(function(e,t){"success"==t&&(this.savingPage=!1,a?this.$manualLoader.addClass("hidden"):this.$addEntryLoader.addClass("hidden"),e.success?(a&&(this.$manualForm.find("#name").val(""),this.$manualForm.find("#url").val("")),this.addPage(e.pageData),this.$parentContainer.html(e.parentOptions),Craft.cp.displayNotice(e.message)):Craft.cp.displayError(e.message))},this))},addPage:function(t){var a=this.$template.replace(/%%id%%/gi,t.id).replace(/%%status%%/gi,t.enabled?"live":"expired").replace(/%%label%%/gi,t.name).replace(/%%url%%/gi,t.url).replace(/%%blank%%/gi,t.blank?"":"visuallyhidden"),i=e(a);this.structure.addElement(i,t.parentId)},showPageIds:function(){e(".amnav__id").toggleClass("visuallyhidden")}}),Craft.AmNavStructure=Craft.Structure.extend({navId:null,$emptyContainer:e(".amnav__empty"),init:function(t,a,i,s){if(this.navId=t,this.base(a,i,s),this.structureDrag=new Craft.AmNavStructureDrag(this,this.settings.maxLevels),this.$container.find(".settings").on("click",e.proxy(function(t){this.showPageEditor(e(t.currentTarget).parent().children(".amnav__page"))},this)),this.$container.find(".delete").on("click",e.proxy(function(t){this.removeElement(e(t.currentTarget))},this)),this.addListener(e(".amnav__page"),"dblclick",function(t){this.showPageEditor(e(t.currentTarget))}),!this.settings.isAdmin&&this.settings.canMoveFromLevel>1){var n=this,r=this.$container.find("li").filter(function(){return e(this).data("level")<n.settings.canMoveFromLevel});this.structureDrag.removeItems(r)}},addElement:function(t,a){var i=this.$container;if(a>0){var s=this.$container.find('.amnav__page[data-id="'+a+'"]').closest("li"),n=s.find("> ul");n.length||(n=e("<ul/>"),n.appendTo(s)),i=n}var r=e('<li data-level="1"/>').appendTo(i),l=e('<div class="row" style="margin-'+Craft.left+": -"+Craft.Structure.baseIndent+"px; padding-"+Craft.left+": "+Craft.Structure.baseIndent+'px;">').appendTo(r);l.append(t),l.append('<a class="move icon" title="'+Craft.t("Move")+'"></a>'),l.append('<a class="settings icon" title="'+Craft.t("Settings")+'"></a>'),l.append('<a class="delete icon" title="'+Craft.t("Delete")+'"></a>'),this.structureDrag.addItems(r),l.find(".settings").on("click",e.proxy(function(t){this.showPageEditor(e(t.currentTarget).parent().children(".amnav__page"))},this)),l.find(".delete").on("click",e.proxy(function(t){this.removeElement(e(t.currentTarget))},this)),t.on("dblclick",e.proxy(function(t){this.showPageEditor(e(t.currentTarget))},this)),l.css("margin-bottom",-30),l.velocity({"margin-bottom":0},"fast"),this.$container.find(".amnav__page").length&&this.$emptyContainer.addClass("hidden")},removeElement:function(t){var a=t.closest("li");if(confirmation=confirm(Craft.t("Are you sure you want to delete “{name}” and its descendants?",{name:a.find(".amnav__page").data("label")}))){if(this.removePage(t.parent().find(".amnav__page")),this.structureDrag.removeItems(a),!a.siblings().length)var i=a.parent();a.css("visibility","hidden").velocity({marginBottom:-a.height()},"fast",e.proxy(function(){a.remove(),this.$container.find(".amnav__page").length||this.$emptyContainer.removeClass("hidden"),"undefined"!=typeof i&&"amnav__builder"!=i.attr("id")&&this._removeUl(i)},this))}},removePage:function(t){var a=t.data("id"),i={pageId:a};Craft.postActionRequest("amNav/pages/deletePage",i,e.proxy(function(t,a){"success"==a&&t.success&&(e(".amnav__parent").html(t.parentOptions),Craft.cp.displayNotice(t.message))},this))},showPageEditor:function(e){new Craft.AmNavEditor(e)}}),Craft.AmNavStructureDrag=Craft.StructureDrag.extend({onDragStop:function(){if(this._.$closestTarget&&(this.$insertion.parent().length||this._.$closestTarget.hasClass("draghover"))){if(this.$draggee.siblings().length)var t=null;else var t=this.$draggee.parent();if(this.$insertion.parent().length){var a=this.$insertion.next().add(this.$insertion.prev());if(-1==e.inArray(this.$draggee[0],a)){this.$insertion.replaceWith(this.$draggee);var i=!0}else{this.$insertion.remove();var i=!1}}else{var s=this._.$closestTargetLi.children("ul");if(t&&s.length&&s[0]==t[0])var i=!1;else{if(s.length)this._.$closestTargetLi.hasClass("collapsed")&&this._.$closestTarget.children(".toggle").trigger("click");else{var n=e('<div class="toggle" title="'+Craft.t("Show/hide children")+'"/>').prependTo(this._.$closestTarget);this.structure.initToggle(n),s=e("<ul>").appendTo(this._.$closestTargetLi)}this.$draggee.appendTo(s);var i=!0}}if(this._.$closestTarget.removeClass("draghover"),i){t&&this.structure._removeUl(t);var r=this.$draggee.parentsUntil(this.structure.$container,"li").length+1;if(r!=this.$draggee.data("level")){if(1==this.$draggee.data("level")){var l={};l["padding-"+Craft.left]=38,this.$helperLi.velocity(l,"fast")}else if(1==r){var l={};l["padding-"+Craft.left]=Craft.Structure.baseIndent,this.$helperLi.velocity(l,"fast")}this.setLevel(this.$draggee,r)}var d=this.$draggee.children(".row").children(".element"),o={navId:this.structure.navId,pageId:d.data("id"),prevId:d.closest("li").prev().children(".row").children(".element").data("id"),parentId:this.$draggee.parent("ul").parent("li").children(".row").children(".element").data("id")};Craft.postActionRequest("amNav/pages/movePage",o,function(t,a){"success"==a&&(e(".amnav__parent").html(t.parentOptions),Craft.cp.displayNotice(Craft.t("New order saved.")))})}}this.$draggee.stop().removeClass("hidden").velocity({height:this.draggeeHeight},"fast",e.proxy(function(){this.$draggee.css("height","auto")},this)),this.returnHelpersToDraggees(),this.base()}}),Craft.AmNavEditor=Garnish.Base.extend({$page:null,pageId:null,$form:null,$fieldsContainer:null,$cancelBtn:null,$saveBtn:null,$spinner:null,hud:null,init:function(t){this.$page=t,this.pageId=t.data("id"),this.$page.addClass("loading");var a={pageId:this.pageId};Craft.postActionRequest("amNav/pages/getEditorHtml",a,e.proxy(this,"showHud"))},showHud:function(t,a){if(this.$page.removeClass("loading"),"success"==a){var i=e();this.$form=e("<form/>"),e('<input type="hidden" name="pageId" value="'+this.pageId+'">').appendTo(this.$form),this.$fieldsContainer=e('<div class="fields"/>').appendTo(this.$form),this.$fieldsContainer.html(t.html),Craft.initUiElements(this.$fieldsContainer);var s=e('<div class="footer"/>').appendTo(this.$form);this.$spinner=e('<div class="spinner hidden"/>').appendTo(s);var n=e('<div class="buttons right"/>').appendTo(s);this.$cancelBtn=e('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(n),this.$saveBtn=e('<input class="btn submit" type="submit" value="'+Craft.t("Save")+'"/>').appendTo(n),i=i.add(this.$form),this.hud=new Garnish.HUD(this.$page,i,{bodyClass:"body elementeditor",closeOtherHUDs:!1}),this.hud.on("hide",e.proxy(function(){delete this.hud},this)),this.addListener(this.$form,"submit","savePage"),this.addListener(this.$cancelBtn,"click",function(){this.hud.hide()})}},savePage:function(t){t.preventDefault(),this.$spinner.removeClass("hidden");var a=this.$form.serialize(),i=this.$page.find(".status"),s=this.$page.find(".amnav__blank");Craft.postActionRequest("amNav/pages/savePage",a,e.proxy(function(e,t){this.$spinner.addClass("hidden"),"success"==t&&("success"==t&&e.success?(Craft.cp.displayNotice(e.message),this.$page.data("label",e.pageData.name),this.$page.find(".title").text(e.pageData.name),e.pageData.enabled?(i.addClass("live"),i.removeClass("expired")):(i.addClass("expired"),i.removeClass("live")),e.pageData.blank?s.removeClass("visuallyhidden"):s.addClass("visuallyhidden"),this.closeHud()):Garnish.shake(this.hud.$hud))},this))},closeHud:function(){this.hud.hide(),delete this.hud}})}(jQuery);