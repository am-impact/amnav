!function(e){Craft.AmNav=Garnish.Base.extend({id:null,modal:null,structure:null,locale:null,siteUrl:"",savingNode:!1,entrySources:"",$template:e("#amnav__row").html(),$buildContainer:e(".amnav__builder"),$parentContainer:e(".amnav__parent"),$addEntryButton:e(".amnav__button"),$addEntryLoader:e(".amnav__button").parent().find(".spinner"),$manualForm:e("#manual-form"),$manualLoader:e("#manual-form").find(".spinner"),$displayIdsButton:e(".amnav__nodeids"),init:function(e,t){this.id=e,this.locale=t.locale,this.siteUrl=t.siteUrl,this.entrySources=t.entrySources,this.structure=new Craft.AmNavStructure(e,"#amnav__builder",".amnav__builder",t),this.addListener(this.$addEntryButton,"activate","showModal"),this.addListener(this.$manualForm,"submit","onManualSubmit"),this.addListener(this.$displayIdsButton,"click","showNodeIds")},showModal:function(){this.savingNode||(this.modal?this.modal.show():this.modal=this.createModal())},createModal:function(){return Craft.createElementSelectorModal("Entry",{criteria:{locale:this.locale},sources:this.entrySources,multiSelect:!0,onSelect:e.proxy(this,"onModalSelect")})},onModalSelect:function(e){for(var t=this.$parentContainer.find("#parent").val(),a=0;a<e.length;a++){var i=e[a];this.modal.$body.find('.element[data-id="'+i.id+'"]').closest("tr").removeClass("sel"),i.url=i.url.replace(this.siteUrl,"{siteUrl}");var n={navId:this.id,name:i.label,url:i.url,enabled:"live"==i.status,entryId:i.id,locale:this.locale,parentId:void 0===t?0:t};this.saveNewNode(n,!1)}},onManualSubmit:function(e){if(!this.savingNode){var t=this.$parentContainer.find("#parent").val(),a={navId:this.id,name:this.$manualForm.find("#name").val(),url:this.$manualForm.find("#url").val(),blank:"1"==this.$manualForm.find('input[name="blank"]').val(),locale:this.locale,parentId:void 0===t?0:t};this.saveNewNode(a,!0)}e.preventDefault()},saveNewNode:function(t,a){this.savingNode=!0,a?this.$manualLoader.removeClass("hidden"):this.$addEntryLoader.removeClass("hidden"),Craft.postActionRequest("amNav/nodes/saveNewNode",t,e.proxy(function(e,t){"success"==t&&(this.savingNode=!1,a?this.$manualLoader.addClass("hidden"):this.$addEntryLoader.addClass("hidden"),e.success?(a&&(this.$manualForm.find("#name").val(""),this.$manualForm.find("#url").val("")),this.addNode(e.nodeData),this.$parentContainer.html(e.parentOptions),Craft.cp.displayNotice(e.message)):Craft.cp.displayError(e.message))},this))},addNode:function(t){var a=this.$template.replace(/%%id%%/gi,t.id).replace(/%%status%%/gi,t.enabled?"live":"expired").replace(/%%label%%/gi,t.name).replace(/%%url%%/gi,t.url.replace("{siteUrl}",this.siteUrl)).replace(/%%urlless%%/gi,t.url.replace("{siteUrl}","")).replace(/%%blank%%/gi,t.blank?"":"visuallyhidden"),i=e(a);this.structure.addElement(i,t.parentId)},showNodeIds:function(){e(".amnav__id").toggleClass("visuallyhidden")}}),Craft.AmNavStructure=Craft.Structure.extend({navId:null,$emptyContainer:e(".amnav__empty"),init:function(t,a,i,n){if(this.navId=t,this.base(a,i,n),this.structureDrag=new Craft.AmNavStructureDrag(this,this.settings.maxLevels),this.$container.find(".settings").on("click",e.proxy(function(t){this.showNodeEditor(e(t.currentTarget).parent().children(".amnav__node"))},this)),this.$container.find(".delete").on("click",e.proxy(function(t){this.removeElement(e(t.currentTarget))},this)),this.addListener(e(".amnav__node"),"dblclick",function(t){this.showNodeEditor(e(t.currentTarget))}),!this.settings.isAdmin&&this.settings.canMoveFromLevel>1){var s=this,r=this.$container.find("li").filter(function(){return e(this).data("level")<s.settings.canMoveFromLevel});this.structureDrag.removeItems(r)}},addElement:function(t,a){var i=this.$container,n=1;if(a>0){var s=this.$container.find('.amnav__node[data-id="'+a+'"]').closest("li"),r=s.find("> ul"),d=s.data("level");r.length||(r=e("<ul/>"),r.appendTo(s)),i=r,d>1&&(n=d+1)}var o=e('<li data-level="'+n+'"/>').appendTo(i),l=this.getIndent(n),h=e('<div class="row" style="margin-'+Craft.left+": -"+l+"px; padding-"+Craft.left+": "+l+'px;">').appendTo(o);h.append(t),h.append('<a class="move icon" title="'+Craft.t("Move")+'"></a>'),h.append('<a class="settings icon" title="'+Craft.t("Settings")+'"></a>'),h.append('<a class="delete icon" title="'+Craft.t("Delete")+'"></a>'),this.structureDrag.addItems(o),h.find(".settings").on("click",e.proxy(function(t){this.showNodeEditor(e(t.currentTarget).parent().children(".amnav__node"))},this)),h.find(".delete").on("click",e.proxy(function(t){this.removeElement(e(t.currentTarget))},this)),t.on("dblclick",e.proxy(function(t){this.showNodeEditor(e(t.currentTarget))},this)),h.css("margin-bottom",-30),h.velocity({"margin-bottom":0},"fast"),this.$container.find(".amnav__node").length&&this.$emptyContainer.addClass("hidden")},removeElement:function(t){var a=t.closest("li");if(confirmation=confirm(Craft.t("Are you sure you want to delete “{name}” and its descendants?",{name:a.find(".amnav__node").data("label")}))){if(this.removeNode(t.parent().find(".amnav__node")),this.structureDrag.removeItems(a),!a.siblings().length)var i=a.parent();a.css("visibility","hidden").velocity({marginBottom:-a.height()},"fast",e.proxy(function(){a.remove(),this.$container.find(".amnav__node").length||this.$emptyContainer.removeClass("hidden"),"undefined"!=typeof i&&"amnav__builder"!=i.attr("id")&&this._removeUl(i)},this))}},removeNode:function(t){var a=t.data("id"),i={nodeId:a};Craft.postActionRequest("amNav/nodes/deleteNode",i,e.proxy(function(t,a){"success"==a&&t.success&&(e(".amnav__parent").html(t.parentOptions),Craft.cp.displayNotice(t.message))},this))},showNodeEditor:function(e){new Craft.AmNavEditor(e)}}),Craft.AmNavStructureDrag=Craft.StructureDrag.extend({onDragStop:function(){if(this._.$closestTarget&&(this.$insertion.parent().length||this._.$closestTarget.hasClass("draghover"))){if(this.$draggee.siblings().length)var t=null;else var t=this.$draggee.parent();if(this.$insertion.parent().length){var a=this.$insertion.next().add(this.$insertion.prev());if(-1==e.inArray(this.$draggee[0],a)){this.$insertion.replaceWith(this.$draggee);var i=!0}else{this.$insertion.remove();var i=!1}}else{var n=this._.$closestTargetLi.children("ul");if(t&&n.length&&n[0]==t[0])var i=!1;else{if(n.length)this._.$closestTargetLi.hasClass("collapsed")&&this._.$closestTarget.children(".toggle").trigger("click");else{var s=e('<div class="toggle" title="'+Craft.t("Show/hide children")+'"/>').prependTo(this._.$closestTarget);this.structure.initToggle(s),n=e("<ul>").appendTo(this._.$closestTargetLi)}this.$draggee.appendTo(n);var i=!0}}if(this._.$closestTarget.removeClass("draghover"),i){t&&this.structure._removeUl(t);var r=this.$draggee.parentsUntil(this.structure.$container,"li").length+1;if(r!=this.$draggee.data("level")){if(1==this.$draggee.data("level")){var d={};d["padding-"+Craft.left]=38,this.$helperLi.velocity(d,"fast")}else if(1==r){var d={};d["padding-"+Craft.left]=Craft.Structure.baseIndent,this.$helperLi.velocity(d,"fast")}this.setLevel(this.$draggee,r)}var o=this.$draggee.children(".row").children(".element"),l={navId:this.structure.navId,nodeId:o.data("id"),prevId:o.closest("li").prev().children(".row").children(".element").data("id"),parentId:this.$draggee.parent("ul").parent("li").children(".row").children(".element").data("id")};Craft.postActionRequest("amNav/nodes/moveNode",l,function(t,a){"success"==a&&(e(".amnav__parent").html(t.parentOptions),Craft.cp.displayNotice(Craft.t("New order saved.")))})}}this.$draggee.stop().removeClass("hidden").velocity({height:this.draggeeHeight},"fast",e.proxy(function(){this.$draggee.css("height","auto")},this)),this.returnHelpersToDraggees(),this.base()}}),Craft.AmNavEditor=Garnish.Base.extend({$node:null,nodeId:null,$form:null,$fieldsContainer:null,$cancelBtn:null,$saveBtn:null,$spinner:null,hud:null,init:function(t){this.$node=t,this.nodeId=t.data("id"),this.$node.addClass("loading");var a={nodeId:this.nodeId};Craft.postActionRequest("amNav/nodes/getEditorHtml",a,e.proxy(this,"showHud"))},showHud:function(t,a){if(this.$node.removeClass("loading"),"success"==a){var i=e();this.$form=e("<form/>"),e('<input type="hidden" name="nodeId" value="'+this.nodeId+'">').appendTo(this.$form),this.$fieldsContainer=e('<div class="fields"/>').appendTo(this.$form),this.$fieldsContainer.html(t.html),Craft.initUiElements(this.$fieldsContainer);var n=e('<div class="footer"/>').appendTo(this.$form);this.$spinner=e('<div class="spinner hidden"/>').appendTo(n);var s=e('<div class="buttons right"/>').appendTo(n);this.$cancelBtn=e('<div class="btn">'+Craft.t("Cancel")+"</div>").appendTo(s),this.$saveBtn=e('<input class="btn submit" type="submit" value="'+Craft.t("Save")+'"/>').appendTo(s),i=i.add(this.$form),this.hud=new Garnish.HUD(this.$node,i,{bodyClass:"body elementeditor",closeOtherHUDs:!1}),this.hud.on("hide",e.proxy(function(){delete this.hud},this)),this.addListener(this.$form,"submit","saveNode"),this.addListener(this.$cancelBtn,"click",function(){this.hud.hide()})}},saveNode:function(t){t.preventDefault(),this.$spinner.removeClass("hidden");var a=this.$form.serialize(),i=this.$node.find(".status"),n=this.$node.find(".amnav__blank");Craft.postActionRequest("amNav/nodes/saveNode",a,e.proxy(function(e,t){this.$spinner.addClass("hidden"),"success"==t&&("success"==t&&e.success?(Craft.cp.displayNotice(e.message),this.$node.data("label",e.nodeData.name),this.$node.find(".title").text(e.nodeData.name),e.nodeData.enabled?(i.addClass("live"),i.removeClass("expired")):(i.addClass("expired"),i.removeClass("live")),e.nodeData.blank?n.removeClass("visuallyhidden"):n.addClass("visuallyhidden"),this.closeHud()):Garnish.shake(this.hud.$hud))},this))},closeHud:function(){this.hud.hide(),delete this.hud}})}(jQuery);